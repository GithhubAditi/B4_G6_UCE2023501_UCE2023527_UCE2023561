# -*- coding: utf-8 -*-
"""FINAL_AIML_HACKATHON.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1or_rUegAvKEG8CsekZoReUW4MYDXUxvL
"""

# ================================================
# üß† AI MEMORY PLAN ‚Äî Complete Alzheimer Patient Diary
# ================================================

!pip install gradio text2emotion pandas matplotlib textblob pillow pytesseract kaleido plotly --quiet
!apt install tesseract-ocr -qq  # OCR engine
!pip install transformers torch --quiet
!pip install twilio --quiet  # For WhatsApp notifications
!pip install datasets --quiet  # For Hugging Face datasets

import pandas as pd
import datetime
import matplotlib.pyplot as plt
import gradio as gr
from textblob import TextBlob
from PIL import Image
import pytesseract
import re, os, io, sqlite3
from google.colab import files
import numpy as np
import plotly.graph_objects as go
import plotly.express as px
from transformers import pipeline
import calendar
from datetime import timedelta
import shutil
from google.colab import drive
from twilio.rest import Client  # For WhatsApp integration
from datasets import load_dataset  # For Hugging Face datasets

# === Mount Google Drive for persistent storage ===
try:
    drive.mount('/content/drive')
    DRIVE_MOUNTED = True
    print("‚úÖ Google Drive mounted successfully!")
except:
    DRIVE_MOUNTED = False
    print("‚ö†Ô∏è Google Drive mount failed, using local storage")

# === Twilio Configuration for WhatsApp ===
TWILIO_ACCOUNT_SID = "ACba754b5fc2114189955ba354e0829ea4"
TWILIO_AUTH_TOKEN = "3e0538fd191212a92385129cb10046c1"
TWILIO_WHATSAPP_NUMBER = "whatsapp:+14155238886"  # Twilio sandbox number

print("‚úÖ Twilio credentials configured successfully!")

# === Database Setup with Google Drive persistence ===
def get_database_path():
    """Get database path - use Google Drive if available, else local"""
    if DRIVE_MOUNTED:
        # Create AI_Memory_Plan folder in Drive if it doesn't exist
        drive_folder = '/content/drive/MyDrive/AI_Memory_Plan'
        os.makedirs(drive_folder, exist_ok=True)
        db_path = os.path.join(drive_folder, "ai_memory_plan.db")
        print(f"üìÅ Using Google Drive database: {db_path}")
        return db_path
    else:
        db_path = "ai_memory_plan.db"
        print(f"üìÅ Using local database: {db_path}")
        return db_path

DB_FILE = get_database_path()

def migrate_database():
    """Migrate database to add new columns if they don't exist"""
    conn = sqlite3.connect(DB_FILE)
    cursor = conn.cursor()

    try:
        # Check if users table has the new columns
        cursor.execute("PRAGMA table_info(users)")
        columns = [column[1] for column in cursor.fetchall()]

        # Add phone_number if it doesn't exist
        if 'phone_number' not in columns:
            cursor.execute("ALTER TABLE users ADD COLUMN phone_number TEXT")
            print("‚úÖ Added phone_number column to users table")

        # Add language if it doesn't exist
        if 'language' not in columns:
            cursor.execute("ALTER TABLE users ADD COLUMN language TEXT DEFAULT 'English'")
            print("‚úÖ Added language column to users table")

        # Add theme_preference if it doesn't exist
        if 'theme_preference' not in columns:
            cursor.execute("ALTER TABLE users ADD COLUMN theme_preference TEXT DEFAULT 'default'")
            print("‚úÖ Added theme_preference column to users table")

        # Check if reminders table exists
        cursor.execute("SELECT name FROM sqlite_master WHERE type='table' AND name='reminders'")
        if not cursor.fetchone():
            cursor.execute('''
                CREATE TABLE reminders (
                    id INTEGER PRIMARY KEY AUTOINCREMENT,
                    username TEXT NOT NULL,
                    title TEXT NOT NULL,
                    description TEXT,
                    reminder_date TEXT NOT NULL,
                    reminder_time TEXT NOT NULL,
                    reminder_type TEXT NOT NULL,
                    is_completed BOOLEAN DEFAULT FALSE,
                    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                    FOREIGN KEY (username) REFERENCES users (username)
                )
            ''')
            print("‚úÖ Created reminders table")

        # Check if feedback table exists
        cursor.execute("SELECT name FROM sqlite_master WHERE type='table' AND name='feedback'")
        if not cursor.fetchone():
            cursor.execute('''
                CREATE TABLE feedback (
                    id INTEGER PRIMARY KEY AUTOINCREMENT,
                    username TEXT NOT NULL,
                    rating INTEGER NOT NULL,
                    comments TEXT,
                    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                    FOREIGN KEY (username) REFERENCES users (username)
                )
            ''')
            print("‚úÖ Created feedback table")

        conn.commit()

    except Exception as e:
        print(f"‚ö†Ô∏è Database migration error: {e}")
    finally:
        conn.close()

def init_database():
    """Initialize SQLite database with tables"""
    conn = sqlite3.connect(DB_FILE)
    cursor = conn.cursor()

    # Users table
    cursor.execute('''
        CREATE TABLE IF NOT EXISTS users (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            username TEXT UNIQUE NOT NULL,
            password TEXT NOT NULL,
            name TEXT NOT NULL,
            phone_number TEXT,
            language TEXT DEFAULT 'English',
            theme_preference TEXT DEFAULT 'default',
            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
        )
    ''')

    # Memories table
    cursor.execute('''
        CREATE TABLE IF NOT EXISTS memories (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            username TEXT NOT NULL,
            timestamp TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
            day TEXT NOT NULL,
            date TEXT NOT NULL,
            text TEXT NOT NULL,
            predicted_emotion TEXT NOT NULL,
            scores TEXT NOT NULL,
            image_path TEXT,
            FOREIGN KEY (username) REFERENCES users (username)
        )
    ''')

    # Reminders table
    cursor.execute('''
        CREATE TABLE IF NOT EXISTS reminders (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            username TEXT NOT NULL,
            title TEXT NOT NULL,
            description TEXT,
            reminder_date TEXT NOT NULL,
            reminder_time TEXT NOT NULL,
            reminder_type TEXT NOT NULL,
            is_completed BOOLEAN DEFAULT FALSE,
            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
            FOREIGN KEY (username) REFERENCES users (username)
        )
    ''')

    # Feedback table
    cursor.execute('''
        CREATE TABLE IF NOT EXISTS feedback (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            username TEXT NOT NULL,
            rating INTEGER NOT NULL,
            comments TEXT,
            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
            FOREIGN KEY (username) REFERENCES users (username)
        )
    ''')

    conn.commit()
    conn.close()
    print("‚úÖ Database initialized successfully!")

    # Run migration to ensure all columns exist
    migrate_database()

# Initialize database on startup
init_database()

# === Enhanced Emotion Dataset Integration ===
print("üìä Loading emotion datasets...")

# Load Hugging Face dataset
try:
    emotion_dataset = load_dataset("dair-ai/emotion", split='train')
    hf_df = emotion_dataset.to_pandas()
    hf_df.rename(columns={'text': 'text', 'label': 'label'}, inplace=True)
    hf_df['label'] = hf_df['label'].map({0: 'sadness', 1: 'joy', 2: 'love', 3: 'anger', 4: 'fear', 5: 'surprise'})
    print(f"‚úÖ Hugging Face emotion dataset loaded: {len(hf_df)} samples")
except Exception as e:
    print(f"‚ö†Ô∏è Could not load Hugging Face dataset: {e}")
    hf_df = pd.DataFrame()

# Load external dataset if available
try:
    print("üìÅ Please upload your emotion dataset CSV (e.g., test.csv) or press Enter to skip:")
    uploaded = files.upload()
    filename = list(uploaded.keys())[0] if uploaded else None
    if filename:
        external_df = pd.read_csv(io.BytesIO(uploaded[filename]))
        if 'Text' in external_df.columns and 'Emotion' in external_df.columns:
            external_df.rename(columns={'Text': 'text', 'Emotion': 'label'}, inplace=True)
            print(f"‚úÖ External emotion dataset loaded: {len(external_df)} samples")
        else:
            print("‚ö†Ô∏è External dataset doesn't have required columns (Text, Emotion)")
            external_df = pd.DataFrame()
    else:
        external_df = pd.DataFrame()
        print("‚ÑπÔ∏è No external dataset uploaded")
except Exception as e:
    print(f"‚ö†Ô∏è Error loading external dataset: {e}")
    external_df = pd.DataFrame()

# Combine datasets
if not hf_df.empty and not external_df.empty:
    combined_df = pd.concat([hf_df, external_df], ignore_index=True)
    print(f"‚úÖ Combined dataset: {len(combined_df)} total samples")
elif not hf_df.empty:
    combined_df = hf_df
    print("‚úÖ Using Hugging Face dataset only")
elif not external_df.empty:
    combined_df = external_df
    print("‚úÖ Using external dataset only")
else:
    combined_df = pd.DataFrame(columns=['text', 'label'])
    print("‚ö†Ô∏è No emotion datasets available, using fallback emotion detection")

print("üìà Dataset emotion distribution:")
if not combined_df.empty:
    print(combined_df['label'].value_counts())

# === Enhanced Emotion Prediction with Dataset Comparison ===
try:
    emotion_analyzer = pipeline("text-classification",
                               model="bhadresh-savani/distilbert-base-uncased-emotion",
                               return_all_scores=True)
    print("‚úÖ Advanced emotion analyzer loaded successfully!")
except Exception as e:
    emotion_analyzer = None
    print(f"‚ö†Ô∏è Advanced emotion analyzer failed to load: {e}")
    print("‚ÑπÔ∏è Using enhanced keyword-based emotion detection")

def predict_emotion(text):
    """Enhanced emotion prediction with fallback and confidence scores"""
    text = str(text).strip()
    if len(text) < 2:
        return "Neutral", {"Happy": 0, "Angry": 0, "Surprise": 0, "Sad": 0, "Fear": 0, "Neutral": 1.0}

    try:
        if emotion_analyzer is not None:
            # Use advanced model
            results = emotion_analyzer(text)[0]
            scores = {res['label'].capitalize(): float(res['score']) for res in results}

            # Map to consistent emotion labels
            mapping = {
                "Anger": "Angry",
                "Joy": "Happy",
                "Sadness": "Sad",
                "Surprise": "Surprise",
                "Fear": "Fear",
                "Disgust": "Angry",
                "Neutral": "Neutral"
            }

            normalized_scores = {"Happy": 0, "Angry": 0, "Surprise": 0, "Sad": 0, "Fear": 0, "Neutral": 0}
            for label, score in scores.items():
                if label in mapping:
                    normalized_scores[mapping[label]] += score

            # Normalize scores
            total = sum(normalized_scores.values())
            if total > 0:
                normalized_scores = {k: v/total for k, v in normalized_scores.items()}

            dominant = max(normalized_scores, key=normalized_scores.get)
            return dominant, normalized_scores

    except Exception as e:
        print(f"‚ö†Ô∏è Advanced emotion analysis failed: {e}")

    # Enhanced keyword-based fallback
    text_lower = text.lower()

    emotion_keywords = {
        "Happy": ['happy', 'joy', 'good', 'great', 'wonderful', 'excited', 'amazing', 'love', 'loved', 'fantastic',
                 'excellent', 'beautiful', 'perfect', 'smile', 'laugh', 'enjoy', 'pleased', 'delighted', 'bliss'],
        "Sad": ['sad', 'unhappy', 'cry', 'bad', 'terrible', 'awful', 'depressed', 'miserable', 'heartbroken',
               'miss', 'lost', 'grief', 'sorrow', 'tear', 'upset', 'disappointed', 'hopeless'],
        "Angry": ['angry', 'mad', 'frustrated', 'annoyed', 'furious', 'irritated', 'outraged', 'hate',
                 'rage', 'fuming', 'livid', 'resent', 'bitter', 'hostile'],
        "Fear": ['scared', 'afraid', 'fear', 'worried', 'anxious', 'nervous', 'terrified', 'panic',
                'dread', 'horror', 'phobia', 'uneasy', 'apprehensive'],
        "Surprise": ['surprised', 'shocked', 'amazed', 'astonished', 'unexpected', 'wow', 'incredible',
                    'unbelievable', 'astounding', 'stunned']
    }

    scores = {"Happy": 0, "Angry": 0, "Surprise": 0, "Sad": 0, "Fear": 0, "Neutral": 0.1}

    for emotion, keywords in emotion_keywords.items():
        score = sum(1 for keyword in keywords if keyword in text_lower)
        scores[emotion] = score * 2  # Weight keyword matches

    # Add sentiment analysis boost
    try:
        sentiment = TextBlob(text).sentiment.polarity
        if sentiment > 0.3:
            scores["Happy"] += 3
        elif sentiment < -0.3:
            scores["Sad"] += 3
    except:
        pass

    # Normalize scores
    total = sum(scores.values())
    if total > 0:
        scores = {k: v/total for k, v in scores.items()}

    dominant = max(scores, key=scores.get)
    return dominant, scores

def compare_with_dataset(user_emotion):
    """Compare user emotion with dataset distribution"""
    if combined_df.empty or 'label' not in combined_df.columns:
        return "‚ö†Ô∏è No emotion dataset available for comparison."

    # Get dataset emotion distribution
    emotion_counts = combined_df['label'].value_counts(normalize=True) * 100

    # Map user emotion to dataset labels if needed
    user_emotion_lower = user_emotion.lower()
    dataset_emotions = emotion_counts.index.str.lower().tolist()

    # Find closest matching emotion in dataset
    matching_emotion = None
    for dataset_emotion in dataset_emotions:
        if user_emotion_lower in dataset_emotion or dataset_emotion in user_emotion_lower:
            matching_emotion = dataset_emotion
            break

    if matching_emotion:
        dataset_percentage = emotion_counts[emotion_counts.index.str.lower() == matching_emotion].iloc[0]
        top_dataset_emotion = emotion_counts.index[0]
        top_percentage = emotion_counts.iloc[0]

        comparison = f"""
        üìä Dataset Comparison:
        ‚Ä¢ Your emotion '{user_emotion}' matches '{matching_emotion.title()}' in dataset
        ‚Ä¢ '{matching_emotion.title()}' appears in {dataset_percentage:.1f}% of dataset entries
        ‚Ä¢ Most common emotion in dataset: '{top_dataset_emotion}' ({top_percentage:.1f}%)
        """

        if user_emotion_lower == top_dataset_emotion.lower():
            comparison += "\n‚úÖ Your emotion matches the dataset's most common mood!"
        else:
            comparison += f"\n‚ÑπÔ∏è Your emotion differs from the most common dataset mood ('{top_dataset_emotion}')"

        return comparison
    else:
        return f"‚ö†Ô∏è Emotion '{user_emotion}' not found in dataset. Dataset emotions: {', '.join(emotion_counts.index.tolist())}"

def send_whatsapp_reminder(phone_number, message):
    """Send WhatsApp reminder using Twilio"""
    try:
        if not phone_number:
            return False, "üì± Phone number not provided."

        client = Client(TWILIO_ACCOUNT_SID, TWILIO_AUTH_TOKEN)

        message = client.messages.create(
            body=message,
            from_=TWILIO_WHATSAPP_NUMBER,
            to=f"whatsapp:{phone_number}"
        )
        return True, f"üì± WhatsApp reminder sent successfully!"
    except Exception as e:
        error_msg = str(e)
        if "Authenticate" in error_msg:
            return False, "‚ùå Twilio authentication failed."
        elif "not a valid phone number" in error_msg:
            return False, "‚ùå Invalid phone number format. Use: +1234567890"
        elif "not enrolled" in error_msg:
            return False, "‚ùå WhatsApp sandbox not configured. Send 'join <keyword>' to Twilio WhatsApp number."
        else:
            return False, f"‚ùå Failed to send WhatsApp reminder: {error_msg}"

# === Enhanced Validation Functions ===
def validate_password(password):
    """Validate password strength"""
    if len(password) < 6:
        return False, "‚ùå Password must be at least 6 characters long"
    if not any(char.isdigit() for char in password):
        return False, "‚ùå Password must contain at least one number"
    if not any(char.isalpha() for char in password):
        return False, "‚ùå Password must contain at least one letter"
    return True, "‚úÖ Password is strong"

def validate_date(date_str):
    """Validate date format"""
    try:
        datetime.datetime.strptime(date_str, '%Y-%m-%d')
        return True, "‚úÖ Date is valid"
    except ValueError:
        return False, "‚ùå Invalid date format. Please use YYYY-MM-DD"

def validate_time(time_str):
    """Validate time format"""
    try:
        datetime.datetime.strptime(time_str, '%H:%M')
        return True, "‚úÖ Time is valid"
    except ValueError:
        return False, "‚ùå Invalid time format. Please use HH:MM"

def validate_phone_number(phone):
    """Validate phone number format"""
    if not phone:
        return True, "‚ÑπÔ∏è Phone number is optional for WhatsApp reminders"

    if len(phone) < 10:
        return False, "‚ùå Phone number seems too short"

    if not (phone.startswith('+') or phone.isdigit()):
        return False, "‚ùå Phone number should start with + or contain only digits"

    return True, "‚úÖ Phone number is valid"

# === Enhanced OCR text extraction ===
def extract_text_from_image(image_data):
    """Extract text from images using OCR"""
    try:
        if isinstance(image_data, np.ndarray):
            img = Image.fromarray(image_data.astype('uint8'))
        elif isinstance(image_data, Image.Image):
            img = image_data
        else:
            return ""

        extracted = pytesseract.image_to_string(img)
        extracted = extracted.strip()

        # Filter out very short or meaningless text
        if len(extracted) < 3:
            return ""

        words = extracted.split()
        meaningful_words = [word for word in words if len(word) > 2]

        if not meaningful_words:
            return ""

        meaningful_text = ' '.join(meaningful_words)

        if len(meaningful_text) < 10:
            return ""

        return meaningful_text

    except Exception as e:
        print(f"OCR Error: {e}")
        return ""

# === User session with enhanced preferences ===
current_user = {
    "username": None,
    "name": None,
    "logged_in": False,
    "language": 'English',
    "theme": 'default',
    "phone_number": None
}

# === Enhanced Database Functions ===
def register_user_db(username, password, name, phone_number=None, language='English', theme_preference='default'):
    """Register a new user in the database"""
    is_valid, password_msg = validate_password(password)
    if not is_valid:
        return False, password_msg

    if phone_number:
        is_valid, phone_msg = validate_phone_number(phone_number)
        if not is_valid:
            return False, phone_msg

    conn = sqlite3.connect(DB_FILE)
    cursor = conn.cursor()
    try:
        cursor.execute(
            "INSERT INTO users (username, password, name, phone_number, language, theme_preference) VALUES (?, ?, ?, ?, ?, ?)",
            (username, password, name, phone_number, language, theme_preference)
        )
        conn.commit()
        conn.close()
        return True, f"‚úÖ Registration successful! Welcome, {name}."
    except sqlite3.IntegrityError:
        conn.close()
        return False, "‚ùå Username already exists. Please try a different username."
    except Exception as e:
        conn.close()
        return False, f"‚ùå Registration error: {str(e)}"

def login_user_db(username, password):
    """Authenticate user from database"""
    conn = sqlite3.connect(DB_FILE)
    cursor = conn.cursor()
    cursor.execute(
        "SELECT username, name, language, theme_preference, phone_number FROM users WHERE username = ? AND password = ?",
        (username, password)
    )
    result = cursor.fetchone()
    conn.close()

    if result:
        return True, result[0], result[1], result[2], result[3], result[4]
    else:
        return False, None, None, 'English', 'default', None

def update_user_preferences(username, language, theme_preference, phone_number):
    """Update user preferences"""
    conn = sqlite3.connect(DB_FILE)
    cursor = conn.cursor()
    try:
        cursor.execute(
            "UPDATE users SET language = ?, theme_preference = ?, phone_number = ? WHERE username = ?",
            (language, theme_preference, phone_number, username)
        )
        conn.commit()
        conn.close()
        return True, "‚úÖ Preferences updated successfully!"
    except Exception as e:
        conn.close()
        return False, f"‚ùå Error updating preferences: {str(e)}"

def save_feedback_db(username, rating, comments):
    """Save user feedback to database"""
    conn = sqlite3.connect(DB_FILE)
    cursor = conn.cursor()
    try:
        cursor.execute(
            "INSERT INTO feedback (username, rating, comments) VALUES (?, ?, ?)",
            (username, rating, comments)
        )
        conn.commit()
        conn.close()
        return True, "‚úÖ Thank you for your feedback! Your response has been recorded."
    except Exception as e:
        conn.close()
        return False, f"‚ùå Error saving feedback: {str(e)}"

def has_user_given_feedback(username):
    """Check if user has already given feedback"""
    conn = sqlite3.connect(DB_FILE)
    cursor = conn.cursor()
    cursor.execute(
        "SELECT COUNT(*) FROM feedback WHERE username = ?",
        (username,)
    )
    result = cursor.fetchone()
    conn.close()
    return result[0] > 0

def save_memory_db(memory_data):
    """Save memory entry to database"""
    conn = sqlite3.connect(DB_FILE)
    cursor = conn.cursor()
    try:
        cursor.execute('''
            INSERT INTO memories
            (username, timestamp, day, date, text, predicted_emotion, scores, image_path)
            VALUES (?, ?, ?, ?, ?, ?, ?, ?)
        ''', (
            memory_data["username"],
            memory_data["timestamp"],
            memory_data["day"],
            memory_data["date"],
            memory_data["text"],
            memory_data["predicted_emotion"],
            memory_data["scores"],
            memory_data["image_path"]
        ))
        conn.commit()
        conn.close()
        return True
    except Exception as e:
        conn.close()
        print(f"Database error: {e}")
        return False

def get_user_memories(username, limit=100):
    """Retrieve user memories from database"""
    conn = sqlite3.connect(DB_FILE)
    cursor = conn.cursor()
    cursor.execute('''
        SELECT id, timestamp, day, date, text, predicted_emotion, image_path
        FROM memories
        WHERE username = ?
        ORDER BY timestamp DESC
        LIMIT ?
    ''', (username, limit))

    results = cursor.fetchall()
    conn.close()

    if not results:
        return None

    columns = ["id", "timestamp", "day", "date", "text", "predicted_emotion", "image_path"]
    memories = [dict(zip(columns, row)) for row in results]
    return memories

def get_emotion_trends(username):
    """Get emotion counts for trend analysis"""
    conn = sqlite3.connect(DB_FILE)
    cursor = conn.cursor()
    cursor.execute('''
        SELECT predicted_emotion, COUNT(*) as count
        FROM memories
        WHERE username = ?
        GROUP BY predicted_emotion
        ORDER BY count DESC
    ''', (username,))

    results = cursor.fetchall()
    conn.close()
    return results

def get_weekly_trends(username):
    """Get weekly emotion trends"""
    conn = sqlite3.connect(DB_FILE)
    cursor = conn.cursor()
    cursor.execute('''
        SELECT
            strftime('%Y-%W', date) as week,
            predicted_emotion,
            COUNT(*) as count
        FROM memories
        WHERE username = ?
        GROUP BY week, predicted_emotion
        ORDER BY week DESC
    ''', (username,))

    results = cursor.fetchall()
    conn.close()
    return results

def get_monthly_trends(username):
    """Get monthly emotion trends"""
    conn = sqlite3.connect(DB_FILE)
    cursor = conn.cursor()
    cursor.execute('''
        SELECT
            strftime('%Y-%m', date) as month,
            predicted_emotion,
            COUNT(*) as count
        FROM memories
        WHERE username = ?
        GROUP BY month, predicted_emotion
        ORDER BY month DESC
    ''', (username,))

    results = cursor.fetchall()
    conn.close()
    return results

def get_daily_trends(username, days=30):
    """Get daily emotion trends for last N days"""
    conn = sqlite3.connect(DB_FILE)
    cursor = conn.cursor()

    end_date = datetime.datetime.now().strftime("%Y-%m-%d")
    start_date = (datetime.datetime.now() - timedelta(days=days)).strftime("%Y-%m-%d")

    cursor.execute('''
        SELECT
            date,
            predicted_emotion,
            COUNT(*) as count
        FROM memories
        WHERE username = ? AND date BETWEEN ? AND ?
        GROUP BY date, predicted_emotion
        ORDER BY date DESC
    ''', (username, start_date, end_date))

    results = cursor.fetchall()
    conn.close()
    return results

def get_all_user_data(username):
    """Get all user data for export"""
    conn = sqlite3.connect(DB_FILE)
    cursor = conn.cursor()
    cursor.execute('''
        SELECT * FROM memories
        WHERE username = ?
        ORDER BY timestamp DESC
    ''', (username,))

    results = cursor.fetchall()
    columns = [description[0] for description in cursor.description]
    conn.close()

    if not results:
        return None

    memories = [dict(zip(columns, row)) for row in results]
    return memories

def get_memories_by_date(username, specific_date):
    """Get memories for a specific date"""
    conn = sqlite3.connect(DB_FILE)
    cursor = conn.cursor()
    cursor.execute('''
        SELECT * FROM memories
        WHERE username = ? AND date = ?
        ORDER BY timestamp DESC
    ''', (username, specific_date))

    results = cursor.fetchall()
    columns = [description[0] for description in cursor.description]
    conn.close()

    if not results:
        return None

    memories = [dict(zip(columns, row)) for row in results]
    return memories

def get_dates_with_memories(username):
    """Get all dates that have memories"""
    conn = sqlite3.connect(DB_FILE)
    cursor = conn.cursor()
    cursor.execute('''
        SELECT DISTINCT date FROM memories
        WHERE username = ?
        ORDER BY date DESC
    ''', (username,))

    results = cursor.fetchall()
    conn.close()

    dates = [result[0] for result in results]
    return dates

def save_reminder_db(reminder_data):
    """Save reminder to database"""
    conn = sqlite3.connect(DB_FILE)
    cursor = conn.cursor()
    try:
        cursor.execute('''
            INSERT INTO reminders
            (username, title, description, reminder_date, reminder_time, reminder_type)
            VALUES (?, ?, ?, ?, ?, ?)
        ''', (
            reminder_data["username"],
            reminder_data["title"],
            reminder_data["description"],
            reminder_data["reminder_date"],
            reminder_data["reminder_time"],
            reminder_data["reminder_type"]
        ))
        conn.commit()
        conn.close()
        return True, "‚úÖ Reminder saved successfully!"
    except Exception as e:
        conn.close()
        return False, f"‚ùå Error saving reminder: {str(e)}"

def get_user_reminders(username):
    """Get all reminders for a user"""
    conn = sqlite3.connect(DB_FILE)
    cursor = conn.cursor()
    cursor.execute('''
        SELECT * FROM reminders
        WHERE username = ?
        ORDER BY reminder_date DESC, reminder_time DESC
    ''', (username,))

    results = cursor.fetchall()
    columns = [description[0] for description in cursor.description]
    conn.close()

    if not results:
        return None

    reminders = [dict(zip(columns, row)) for row in results]
    return reminders

def delete_reminder_db(reminder_id):
    """Delete a reminder"""
    conn = sqlite3.connect(DB_FILE)
    cursor = conn.cursor()
    try:
        cursor.execute('DELETE FROM reminders WHERE id = ?', (reminder_id,))
        conn.commit()
        conn.close()
        return True, "‚úÖ Reminder deleted successfully!"
    except Exception as e:
        conn.close()
        return False, f"‚ùå Error deleting reminder: {str(e)}"

# === Enhanced Login/Registration handlers ===
def register_user(username, password, name, phone_number, language, theme):
    if not username or not password or not name:
        return "‚ùå All fields are required. Please fill in username, password, and name."

    success, message = register_user_db(username, password, name, phone_number, language, theme)
    return message

def login_user(username, password):
    if not username or not password:
        return "‚ùå Please enter both username and password."

    success, db_username, db_name, language, theme, phone = login_user_db(username, password)
    if success:
        current_user["username"] = db_username
        current_user["name"] = db_name
        current_user["logged_in"] = True
        current_user["language"] = language
        current_user["theme"] = theme
        current_user["phone_number"] = phone

        return f"‚úÖ Welcome back, {db_name}! You can now use all features."
    else:
        return "‚ùå Invalid username or password. Please check your credentials."

def logout_user():
    """Logout user"""
    current_user["username"] = None
    current_user["name"] = None
    current_user["logged_in"] = False
    current_user["language"] = 'English'
    current_user["theme"] = 'default'
    current_user["phone_number"] = None
    return "‚úÖ Logged out successfully!"

def update_preferences(language, theme, phone_number):
    """Update user preferences"""
    if not current_user["username"]:
        return "‚ùå Please log in first to update preferences."

    success, message = update_user_preferences(current_user["username"], language, theme, phone_number)
    if success:
        current_user["language"] = language
        current_user["theme"] = theme
        current_user["phone_number"] = phone_number
        return f"‚úÖ {message}"
    else:
        return f"‚ùå {message}"

# === FIXED Feedback Functions ===
def submit_feedback(rating, comments):
    """Submit user feedback - FIXED VERSION"""
    if not current_user["username"]:
        return "‚ùå Please log in first to submit feedback."

    if not rating:
        return "‚ùå Please select a rating for your experience."

    try:
        # Handle both string and integer ratings
        if isinstance(rating, str):
            # Extract numeric rating from string like "5 - Excellent"
            if ' - ' in rating:
                rating_value = int(rating.split(' - ')[0])
            else:
                rating_value = int(rating)
        else:
            # If it's already an integer, use it directly
            rating_value = int(rating)

        # Validate rating range
        if rating_value < 1 or rating_value > 5:
            return "‚ùå Please select a valid rating between 1 and 5."

    except (ValueError, TypeError) as e:
        return f"‚ùå Invalid rating format: {str(e)}"

    success, message = save_feedback_db(current_user["username"], rating_value, comments)
    return message

def check_feedback_status():
    """Check if user has given feedback"""
    if not current_user["username"]:
        return False
    return has_user_given_feedback(current_user["username"])

# === Enhanced Save Memory Function ===
def save_memory(text, selected_day, image_data):
    """Enhanced save memory with OCR and dataset comparison"""
    if not current_user["logged_in"]:
        return {"Error": "Please log in first."}

    extracted_text = ""
    image_path = ""

    if image_data is not None:
        try:
            if isinstance(image_data, np.ndarray):
                img = Image.fromarray(image_data.astype('uint8'))
            elif isinstance(image_data, Image.Image):
                img = image_data
            else:
                img = None

            if img:
                timestamp_str = datetime.datetime.now().strftime("%Y%m%d_%H%M%S")
                if DRIVE_MOUNTED:
                    images_folder = '/content/drive/MyDrive/AI_Memory_Plan/images'
                    os.makedirs(images_folder, exist_ok=True)
                    image_path = f"{images_folder}/memory_image_{current_user['username']}_{timestamp_str}.png"
                else:
                    image_path = f"memory_image_{current_user['username']}_{timestamp_str}.png"
                img.save(image_path)
                extracted_text = extract_text_from_image(img)
        except Exception as e:
            extracted_text = f"OCR processing failed: {str(e)}"

    # Combine text intelligently
    if text and extracted_text:
        final_text = f"{text}. Also found in image: {extracted_text}"
    elif text:
        final_text = text
    elif extracted_text:
        final_text = f"From image: {extracted_text}"
    else:
        final_text = "No text provided"

    emotion, scores = predict_emotion(final_text)
    now = datetime.datetime.now()
    date = now.strftime("%Y-%m-%d")
    day = selected_day if selected_day else now.strftime("%A")

    memory_data = {
        "username": current_user["username"],
        "timestamp": now.strftime("%Y-%m-%d %H:%M:%S"),
        "day": day,
        "date": date,
        "text": final_text,
        "predicted_emotion": emotion,
        "scores": str(scores),
        "image_path": image_path
    }

    success = save_memory_db(memory_data)

    if success:
        dataset_comp = compare_with_dataset(emotion)

        output_data = {
            "User": current_user["name"],
            "Day": day,
            "Date": date,
            "Memory Text": text if text else "No text provided",
            "Detected Emotion": emotion,
            "Emotion Confidence": {k: f"{v:.2f}" for k, v in scores.items()},
            "Dataset Comparison": dataset_comp,
            "Memory Saved": f"‚úÖ Entry saved successfully for {day}!"
        }

        if extracted_text and len(extracted_text) > 10:
            output_data["Extracted from Image"] = extracted_text

        return output_data
    else:
        return {"Error": "Failed to save memory to database."}

# === Enhanced View Memories Functions ===
def view_user_memories():
    """View user memories with enhanced display"""
    if not current_user["logged_in"]:
        return "Please log in first.", None, None, None

    memories = get_user_memories(current_user["username"])
    if not memories:
        return "No entries yet.", None, None, None

    display_data = []
    for memory in memories:
        display_data.append({
            "ID": memory["id"],
            "Date": memory["date"],
            "Day": memory["day"],
            "Time": memory["timestamp"].split(" ")[1] if " " in memory["timestamp"] else "",
            "Memory": memory["text"][:100] + "..." if len(memory["text"]) > 100 else memory["text"],
            "Emotion": memory["predicted_emotion"],
            "Has Image": "üì∑ Yes" if memory["image_path"] and os.path.exists(memory["image_path"]) else "‚ùå No"
        })

    df_memories = pd.DataFrame(display_data)
    return df_memories, memories, None, None

def view_memory_details(memory_id, memories_list):
    """View details of a specific memory including image"""
    if not memory_id or not memories_list:
        return "Please select a memory first.", None

    try:
        memory_id = int(memory_id)
        memory = next((m for m in memories_list if m["id"] == memory_id), None)

        if not memory:
            return "Memory not found.", None

        details = f"""
        <div style='background: linear-gradient(135deg, #1A1A1A, #2A2A2A); padding: 2rem; border-radius: 12px; color: white;'>
            <h3 style='color: #4ECDC4; margin-bottom: 1rem;'>Memory Details</h3>
            <div style='display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;'>
                <div>
                    <p><strong>üìÖ Date:</strong> {memory['date']}</p>
                    <p><strong>üìÜ Day:</strong> {memory['day']}</p>
                    <p><strong>‚è∞ Time:</strong> {memory['timestamp'].split(' ')[1] if ' ' in memory['timestamp'] else 'N/A'}</p>
                    <p><strong>üòä Emotion:</strong> <span class='emotion-{memory["predicted_emotion"].lower()}'>{memory['predicted_emotion']}</span></p>
                </div>
                <div>
                    <p><strong>üñºÔ∏è Image:</strong> {'Available' if memory['image_path'] and os.path.exists(memory['image_path']) else 'Not Available'}</p>
                </div>
            </div>
            <div style='margin-top: 1rem;'>
                <p><strong>üìñ Memory Text:</strong></p>
                <div style='background: #2A2A2A; padding: 1rem; border-radius: 8px; border-left: 4px solid #4ECDC4;'>
                    {memory['text']}
                </div>
            </div>
        </div>
        """

        image_path = memory.get('image_path')
        if image_path and os.path.exists(image_path):
            try:
                img = Image.open(image_path)
                return details, img
            except Exception as e:
                return details + f"<p style='color: #FF6B6B;'>Error loading image: {str(e)}</p>", None
        else:
            return details, None

    except Exception as e:
        return f"Error loading memory details: {str(e)}", None

# === ENHANCED ANALYTICS FUNCTIONS ===
def view_trends(analysis_type="bar", time_range="all"):
    """Enhanced trends with multiple chart types and time ranges"""
    if not current_user["logged_in"]:
        return "Please log in first."

    # Get data based on time range
    if time_range == "weekly":
        trends_data = get_weekly_trends(current_user["username"])
        if not trends_data:
            return "No weekly data available!"

        df_trends = pd.DataFrame(trends_data, columns=['week', 'emotion', 'count'])
        pivot_df = df_trends.pivot(index='week', columns='emotion', values='count').fillna(0)

    elif time_range == "monthly":
        trends_data = get_monthly_trends(current_user["username"])
        if not trends_data:
            return "No monthly data available!"

        df_trends = pd.DataFrame(trends_data, columns=['month', 'emotion', 'count'])
        pivot_df = df_trends.pivot(index='month', columns='emotion', values='count').fillna(0)

    elif time_range == "daily":
        trends_data = get_daily_trends(current_user["username"])
        if not trends_data:
            return "No daily data available!"

        df_trends = pd.DataFrame(trends_data, columns=['date', 'emotion', 'count'])
        pivot_df = df_trends.pivot(index='date', columns='emotion', values='count').fillna(0)

    else:  # all time
        trends = get_emotion_trends(current_user["username"])
        if not trends:
            return "No memories yet!"

        emotions = [trend[0] for trend in trends]
        counts = [trend[1] for trend in trends]
        df_trends = pd.DataFrame({'emotion': emotions, 'count': counts})
        pivot_df = None

    # Create different chart types
    if analysis_type == "bar":
        if pivot_df is not None:
            fig, ax = plt.subplots(figsize=(12, 6))
            pivot_df.plot(kind='bar', ax=ax, alpha=0.8)
            plt.title(f"{current_user['name']}'s Emotional Journey - {time_range.capitalize()} View", fontsize=16, fontweight='bold', pad=20)
            plt.xlabel('Time Period', fontweight='bold')
            plt.ylabel('Memory Count', fontweight='bold')
            plt.xticks(rotation=45)
            plt.legend(title='Emotions')
            plt.grid(axis='y', alpha=0.3)
            plt.tight_layout()
        else:
            fig, ax = plt.subplots(figsize=(10, 6))
            colors = ['#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4', '#FFEAA7', '#DDA0DD']
            bars = plt.bar(emotions, counts, color=colors[:len(emotions)], alpha=0.8)

            for bar, count in zip(bars, counts):
                plt.text(bar.get_x() + bar.get_width()/2, bar.get_height() + 0.1,
                        f'{count}', ha='center', va='bottom', fontweight='bold')

            plt.title(f"{current_user['name']}'s Emotional Journey", fontsize=16, fontweight='bold', pad=20)
            plt.xlabel('Emotions', fontweight='bold')
            plt.ylabel('Memory Count', fontweight='bold')
            plt.xticks(rotation=45)
            plt.grid(axis='y', alpha=0.3)
            plt.tight_layout()

    elif analysis_type == "pie":
        fig, ax = plt.subplots(figsize=(10, 8))
        if pivot_df is not None:
            latest_data = pivot_df.iloc[0]
            emotions = latest_data.index
            counts = latest_data.values
            plt.pie(counts, labels=emotions, autopct='%1.1f%%', startangle=90)
            plt.title(f"Emotion Distribution - Latest {time_range.capitalize()}", fontsize=16, fontweight='bold')
        else:
            plt.pie(counts, labels=emotions, autopct='%1.1f%%', startangle=90)
            plt.title(f"{current_user['name']}'s Emotion Distribution", fontsize=16, fontweight='bold')

    elif analysis_type == "line":
        if pivot_df is not None:
            fig, ax = plt.subplots(figsize=(12, 6))
            pivot_df.plot(kind='line', ax=ax, marker='o', linewidth=2, markersize=6)
            plt.title(f"{current_user['name']}'s Emotional Trends - {time_range.capitalize()}", fontsize=16, fontweight='bold', pad=20)
            plt.xlabel('Time Period', fontweight='bold')
            plt.ylabel('Memory Count', fontweight='bold')
            plt.xticks(rotation=45)
            plt.legend(title='Emotions')
            plt.grid(True, alpha=0.3)
            plt.tight_layout()
        else:
            return "Line chart requires time-based data. Please select weekly, monthly, or daily view."

    # Save the plot
    plt.savefig('enhanced_trends.png', dpi=300, bbox_inches='tight')
    plt.close()

    return 'enhanced_trends.png'

# === Fixed Calendar Functions ===
def generate_calendar_view(year=None, month=None):
    """Generate calendar view for the given month and year"""
    if not current_user["logged_in"]:
        return "<div class='logged-out-message'><h3>üîê Please Log In</h3><p>You need to be logged in to view the calendar.</p></div>"

    now = datetime.datetime.now()
    year = year or now.year
    month = month or now.month

    memory_dates = get_dates_with_memories(current_user["username"])

    cal = calendar.Calendar(calendar.SUNDAY)
    month_days = cal.monthdayscalendar(year, month)

    month_name = calendar.month_name[month]

    prev_year, prev_month = (year-1, 12) if month == 1 else (year, month-1)
    next_year, next_month = (year+1, 1) if month == 12 else (year, month+1)

    calendar_html = f"""
    <div class="calendar-section">
        <h2 style="color: #4ECDC4; text-align: center; margin-bottom: 1rem;">Your Memory Calendar</h2>
        <p style="text-align: center; color: #888; margin-bottom: 2rem;">Days with memories are marked with *. Click on a date to view memories.</p>

        <table style="width: 100%; border-collapse: collapse; background: #2A2A2A; border-radius: 8px; overflow: hidden;">
            <thead>
                <tr style="background: #1A1A1A;">
                    <th style="padding: 1rem; color: #4ECDC4; border: 1px solid #333;">Sun</th>
                    <th style="padding: 1rem; color: #4ECDC4; border: 1px solid #333;">Mon</th>
                    <th style="padding: 1rem; color: #4ECDC4; border: 1px solid #333;">Tue</th>
                    <th style="padding: 1rem; color: #4ECDC4; border: 1px solid #333;">Wed</th>
                    <th style="padding: 1rem; color: #4ECDC4; border: 1px solid #333;">Thu</th>
                    <th style="padding: 1rem; color: #4ECDC4; border: 1px solid #333;">Fri</th>
                    <th style="padding: 1rem; color: #4ECDC4; border: 1px solid #333;">Sat</th>
                </tr>
            </thead>
            <tbody>
    """

    for week in month_days:
        calendar_html += '<tr>'
        for day in week:
            if day == 0:
                calendar_html += '<td style="padding: 1rem; border: 1px solid #333; text-align: center; color: #555;"></td>'
            else:
                date_str = f"{year}-{month:02d}-{day:02d}"
                has_memory = date_str in memory_dates
                memory_indicator = " *" if has_memory else ""
                day_color = "#4ECDC4" if has_memory else "white"
                day_style = f"background: {'#1A3A3A' if has_memory else 'transparent'};" if has_memory else ""

                calendar_html += f'<td style="padding: 1rem; border: 1px solid #333; text-align: center; color: {day_color}; font-weight: {"bold" if has_memory else "normal"}; {day_style}">{day}{memory_indicator}</td>'
        calendar_html += '</tr>'

    calendar_html += """
            </tbody>
        </table>

        <div style="text-align: center; margin-top: 1rem; color: #888; font-size: 0.9rem;">
            <p>* Days with memories</p>
        </div>
    </div>
    """

    return calendar_html

def view_calendar_memories(selected_date):
    """View memories for a specific calendar date"""
    if not current_user["logged_in"]:
        return "Please log in first.", None

    if not selected_date:
        return "Please select a date from the calendar.", None

    memories = get_memories_by_date(current_user["username"], selected_date)

    if not memories:
        return f"No memories found for {selected_date}", None

    details_html = f"""
    <div style='background: linear-gradient(135deg, #1A1A1A, #2A2A2A); padding: 2rem; border-radius: 12px; color: white; margin-bottom: 1rem;'>
        <h3 style='color: #4ECDC4; margin-bottom: 1rem;'>üìÖ Memories for {selected_date}</h3>
        <p><strong>Total Memories:</strong> {len(memories)}</p>
    </div>
    """

    for i, memory in enumerate(memories, 1):
        emotion_color = {
            "Happy": "#4ECDC4",
            "Sad": "#45B7D1",
            "Angry": "#FF6B6B",
            "Fear": "#FFEAA7",
            "Surprise": "#96CEB4",
            "Neutral": "#888"
        }.get(memory['predicted_emotion'], "#888")

        details_html += f"""
        <div style='background: #2A2A2A; padding: 1.5rem; border-radius: 8px; margin-bottom: 1rem; border-left: 4px solid {emotion_color};'>
            <div style='display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;'>
                <h4 style='color: {emotion_color}; margin: 0;'>Memory {i}</h4>
                <span style='background: {emotion_color}; color: black; padding: 0.3rem 0.8rem; border-radius: 20px; font-size: 0.9rem; font-weight: bold;'>
                    {memory['predicted_emotion']}
                </span>
            </div>
            <p><strong>Time:</strong> {memory['timestamp'].split(' ')[1] if ' ' in memory['timestamp'] else 'N/A'}</p>
            <p><strong>Memory:</strong> {memory['text']}</p>
            <p><strong>Image:</strong> {'üì∑ Available' if memory['image_path'] and os.path.exists(memory['image_path']) else '‚ùå Not Available'}</p>
        </div>
        """

    return details_html, None

# === Export Data Function ===
def export_user_data():
    if not current_user["logged_in"]:
        return "Please log in first."

    memories = get_all_user_data(current_user["username"])
    if not memories:
        return "No data to export."

    try:
        df_export = pd.DataFrame(memories)

        if 'image_path' in df_export.columns:
            df_export = df_export.drop('image_path', axis=1)

        filename = f"memory_export_{current_user['username']}_{datetime.datetime.now().strftime('%Y%m%d_%H%M%S')}.csv"
        df_export.to_csv(filename, index=False)

        return f"‚úÖ Data exported successfully as {filename}. The file has been saved to your workspace."

    except Exception as e:
        return f"‚ùå Error exporting data: {str(e)}"

# === Profile Statistics ===
def get_user_stats():
    if not current_user["logged_in"]:
        return "Please log in to view statistics."

    conn = sqlite3.connect(DB_FILE)
    cursor = conn.cursor()

    cursor.execute("SELECT COUNT(*) FROM memories WHERE username = ?",
                 (current_user["username"],))
    memory_count = cursor.fetchone()[0]

    cursor.execute('''
        SELECT predicted_emotion, COUNT(*) as count
        FROM memories
        WHERE username = ?
        GROUP BY predicted_emotion
        ORDER BY count DESC
    ''', (current_user["username"],))
    emotions = cursor.fetchall()

    cursor.execute('''
        SELECT date, COUNT(*) as count
        FROM memories
        WHERE username = ?
        GROUP BY date
        ORDER BY date DESC
        LIMIT 7
    ''', (current_user["username"],))
    recent_activity = cursor.fetchall()

    cursor.execute('''
        SELECT COUNT(*) FROM memories
        WHERE username = ? AND image_path IS NOT NULL AND image_path != ''
    ''', (current_user["username"],))
    images_count = cursor.fetchone()[0]

    conn.close()

    stats_html = f"""
    <div style='
        background: linear-gradient(135deg, #1A1A1A, #2A2A2A);
        padding: 2rem;
        border-radius: 12px;
        border: 1px solid #333;
        color: white;
        font-family: Arial, sans-serif;
    '>
        <h2 style='color: #4ECDC4; margin-bottom: 1rem; text-align: center;'>Your Memory Statistics</h2>

        <div style='background: #2A2A2A; padding: 1.5rem; border-radius: 8px; margin-bottom: 1rem;'>
            <h3 style='color: #FF6B6B; margin-top: 0;'>Welcome, {current_user["name"]}!</h3>
            <p style='font-size: 1.2rem; margin: 0.5rem 0;'><strong>Total Memories:</strong> {memory_count}</p>
            <p style='font-size: 1.2rem; margin: 0.5rem 0;'><strong>Memories with Images:</strong> {images_count}</p>
        </div>
    """

    if emotions:
        stats_html += """
        <div style='background: #2A2A2A; padding: 1.5rem; border-radius: 8px; margin-bottom: 1rem;'>
            <h4 style='color: #4ECDC4; margin-top: 0;'>Emotion Distribution:</h4>
        """
        for emotion, count in emotions:
            color = "#4ECDC4" if emotion == "Happy" else "#FF6B6B" if emotion == "Angry" else "#45B7D1" if emotion == "Sad" else "#FFEAA7" if emotion == "Fear" else "#96CEB4"
            stats_html += f"<p style='margin: 0.5rem 0; font-size: 1rem;'><span style='color: {color};'>‚óè</span> {emotion}: {count} memories</p>"
        stats_html += "</div>"

    if recent_activity:
        stats_html += """
        <div style='background: #2A2A2A; padding: 1.5rem; border-radius: 8px;'>
            <h4 style='color: #4ECDC4; margin-top: 0;'>Recent Activity (Last 7 days):</h4>
        """
        for date, count in recent_activity:
            stats_html += f"<p style='margin: 0.5rem 0; font-size: 1rem;'>{date}: {count} memories</p>"
        stats_html += "</div>"

    if not emotions and not recent_activity:
        stats_html += """
        <div style='background: #2A2A2A; padding: 1.5rem; border-radius: 8px; text-align: center;'>
            <p style='color: #888;'>No memories recorded yet. Start adding memories to see your statistics!</p>
        </div>
        """

    stats_html += "</div>"
    return stats_html

# === Reminder Functions ===
def create_reminder(title, description, date, time, reminder_type):
    """Create a new reminder"""
    if not current_user["logged_in"]:
        return "‚ùå Please log in first"

    if not title or not date or not time:
        return "‚ùå Please fill in all required fields (Title, Date, Time)"

    is_valid_date, date_msg = validate_date(date)
    if not is_valid_date:
        return f"‚ùå {date_msg}"

    is_valid_time, time_msg = validate_time(time)
    if not is_valid_time:
        return f"‚ùå {time_msg}"

    reminder_data = {
        "username": current_user["username"],
        "title": title,
        "description": description or "",
        "reminder_date": date,
        "reminder_time": time,
        "reminder_type": reminder_type
    }

    success, message = save_reminder_db(reminder_data)

    if success and current_user.get("phone_number"):
        reminder_message = f"üîî Reminder: {title}\nüìÖ {date} at {time}\nüí¨ {description or 'No additional details'}"
        whatsapp_success, whatsapp_msg = send_whatsapp_reminder(current_user["phone_number"], reminder_message)
        if whatsapp_success:
            message += " üì± WhatsApp reminder sent!"
        else:
            message += f" ‚ö†Ô∏è {whatsapp_msg}"

    return message

def view_reminders():
    """View user reminders"""
    if not current_user["logged_in"]:
        return pd.DataFrame(), []

    reminders = get_user_reminders(current_user["username"])

    if not reminders:
        return pd.DataFrame(columns=["ID", "Title", "Date", "Time", "Type", "Description", "Status"]), []

    df_data = []
    for reminder in reminders:
        df_data.append({
            "ID": reminder["id"],
            "Title": reminder["title"],
            "Date": reminder["reminder_date"],
            "Time": reminder["reminder_time"],
            "Type": reminder["reminder_type"],
            "Description": reminder["description"] or "No description",
            "Status": "‚úÖ Completed" if reminder["is_completed"] else "‚è≥ Pending"
        })

    df = pd.DataFrame(df_data)
    return df, reminders

def delete_reminder(reminder_id):
    """Delete a reminder"""
    if not current_user["logged_in"]:
        return "‚ùå Please log in first"

    if not reminder_id:
        return "‚ùå Please select a reminder to delete"

    success, message = delete_reminder_db(reminder_id)
    return message

# === Theme System ===
THEME_COLORS = {
    'default': {
        'primary': '#1E88E5',
        'accent': '#FF5252',
        'secondary': '#4CAF50',
        'background': '#121212',
        'card_bg': '#1E1E1E',
        'text_primary': '#FFFFFF',
        'text_secondary': '#B0B0B0',
        'border': '#333333',
        'highlight': '#FFC107',
        'button_gradient': 'linear-gradient(135deg, #1E88E5, #FF5252)'
    },
    'happy': {
        'primary': '#FF9800',
        'accent': '#E91E63',
        'secondary': '#8BC34A',
        'background': '#121212',
        'card_bg': '#1E1E1E',
        'text_primary': '#FFFFFF',
        'text_secondary': '#B0B0B0',
        'border': '#333333',
        'highlight': '#FFEB3B',
        'button_gradient': 'linear-gradient(135deg, #FF9800, #E91E63)'
    },
    'calm': {
        'primary': '#2196F3',
        'accent': '#673AB7',
        'secondary': '#00BCD4',
        'background': '#121212',
        'card_bg': '#1E1E1E',
        'text_primary': '#FFFFFF',
        'text_secondary': '#B0B0B0',
        'border': '#333333',
        'highlight': '#4DB6AC',
        'button_gradient': 'linear-gradient(135deg, #2196F3, #673AB7)'
    },
    'energetic': {
        'primary': '#F44336',
        'accent': '#FF5722',
        'secondary': '#FFC107',
        'background': '#121212',
        'card_bg': '#1E1E1E',
        'text_primary': '#FFFFFF',
        'text_secondary': '#B0B0B0',
        'border': '#333333',
        'highlight': '#FFD54F',
        'button_gradient': 'linear-gradient(135deg, #F44336, #FF5722)'
    }
}

def get_theme_css(theme_name):
    """Generate dynamic CSS based on selected theme"""
    theme = THEME_COLORS.get(theme_name, THEME_COLORS['default'])

    return f"""
    <style>
    :root {{
        --primary-color: {theme['primary']};
        --accent-color: {theme['accent']};
        --secondary-color: {theme['secondary']};
        --background-color: {theme['background']};
        --card-bg: {theme['card_bg']};
        --text-primary: {theme['text_primary']};
        --text-secondary: {theme['text_secondary']};
        --border-color: {theme['border']};
        --highlight-color: {theme.get('highlight', theme['accent'])};
        --button-gradient: {theme['button_gradient']};
    }}

    .grok-container {{
        background: var(--background-color) !important;
        color: var(--text-primary) !important;
        font-family: 'Inter', sans-serif;
        min-height: 100vh;
    }}

    .grok-header {{
        background: var(--card-bg) !important;
        color: var(--text-primary) !important;
        border-bottom: 3px solid var(--highlight-color) !important;
        padding: 1.5rem 2rem !important;
    }}

    .grok-logo {{
        font-size: 2.8rem !important;
        font-weight: bold !important;
        background: var(--button-gradient) !important;
        -webkit-background-clip: text !important;
        -webkit-text-fill-color: transparent !important;
        background-clip: text !important;
        margin-bottom: 0.5rem !important;
        text-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }}

    .grok-subtitle {{
        color: var(--text-secondary) !important;
        font-size: 1.2rem !important;
        font-weight: 500 !important;
    }}

    .grok-card {{
        background: var(--card-bg) !important;
        color: var(--text-primary) !important;
        border: 2px solid var(--border-color) !important;
        border-radius: 16px !important;
        padding: 2rem !important;
        margin: 1rem 0 !important;
        box-shadow: 0 4px 20px rgba(0,0,0,0.3) !important;
        transition: all 0.3s ease !important;
    }}

    .grok-card:hover {{
        transform: translateY(-2px) !important;
        box-shadow: 0 8px 30px rgba(0,0,0,0.4) !important;
    }}

    .grok-input {{
        background: var(--card-bg) !important;
        border: 2px solid var(--border-color) !important;
        color: var(--text-primary) !important;
        border-radius: 12px !important;
        padding: 1rem 1.2rem !important;
        font-size: 1rem !important;
        transition: all 0.3s ease !important;
    }}

    .grok-input:focus {{
        border-color: var(--accent-color) !important;
        box-shadow: 0 0 0 3px {theme['accent']}40 !important;
        transform: translateY(-1px);
    }}

    .grok-input::placeholder {{
        color: var(--text-secondary) !important;
        opacity: 0.7;
    }}

    .grok-button {{
        background: var(--button-gradient) !important;
        color: white !important;
        border: none !important;
        border-radius: 12px !important;
        padding: 1.2rem 2.5rem !important;
        font-weight: bold !important;
        font-size: 1.1rem !important;
        transition: all 0.3s ease !important;
        box-shadow: 0 4px 15px rgba(0,0,0,0.3) !important;
    }}

    .grok-button:hover {{
        transform: translateY(-3px) !important;
        box-shadow: 0 8px 25px rgba(0,0,0,0.4) !important;
        filter: brightness(1.1);
    }}

    .grok-button-secondary {{
        background: var(--card-bg) !important;
        color: var(--text-primary) !important;
        border: 2px solid var(--border-color) !important;
        border-radius: 12px !important;
        padding: 1.2rem 2.5rem !important;
        font-weight: bold !important;
        font-size: 1.1rem !important;
        transition: all 0.3s ease !important;
    }}

    .grok-button-secondary:hover {{
        background: var(--secondary-color) !important;
        color: #000000 !important;
        border-color: var(--secondary-color) !important;
        transform: translateY(-2px);
    }}

    .grok-tab {{
        background: var(--card-bg) !important;
        border: 2px solid var(--border-color) !important;
        color: var(--text-secondary) !important;
        border-radius: 12px !important;
        margin: 0.5rem !important;
        padding: 1rem 1.5rem !important;
        font-weight: 600 !important;
        transition: all 0.3s ease !important;
    }}

    .grok-tab:hover {{
        border-color: var(--accent-color) !important;
        color: var(--text-primary) !important;
    }}

    .grok-tab.selected {{
        background: var(--button-gradient) !important;
        color: white !important;
        border: none !important;
        box-shadow: 0 4px 15px rgba(0,0,0,0.3) !important;
    }}

    .hero-image {{
        background: var(--button-gradient) !important;
        color: white !important;
        border: 3px solid var(--highlight-color) !important;
        border-radius: 20px !important;
        padding: 3rem 2rem !important;
        text-align: center !important;
        box-shadow: 0 8px 30px rgba(0,0,0,0.3) !important;
    }}

    .feature-card {{
        background: var(--card-bg) !important;
        color: var(--text-primary) !important;
        border-left: 5px solid var(--secondary-color) !important;
        border-radius: 16px !important;
        padding: 2rem !important;
        margin: 1rem 0 !important;
        box-shadow: 0 4px 20px rgba(0,0,0,0.3) !important;
        transition: all 0.3s ease !important;
    }}

    .feature-card:hover {{
        transform: translateY(-3px) !important;
        box-shadow: 0 8px 30px rgba(0,0,0,0.4) !important;
        border-left-color: var(--accent-color) !important;
    }}

    .user-status {{
        background: var(--card-bg) !important;
        color: var(--text-primary) !important;
        border: 2px solid var(--border-color) !important;
        border-left: 5px solid var(--secondary-color) !important;
        border-radius: 16px !important;
        padding: 2rem !important;
        margin: 1rem 0 !important;
        box-shadow: 0 4px 20px rgba(0,0,0,0.3) !important;
    }}

    .user-status-logged-in {{
        border-left-color: var(--secondary-color) !important;
    }}

    .user-status-logged-out {{
        border-left-color: var(--accent-color) !important;
    }}

    .memory-details {{
        background: var(--card-bg) !important;
        color: var(--text-primary) !important;
        border: 2px solid var(--border-color) !important;
        border-radius: 16px !important;
        padding: 2rem !important;
        box-shadow: 0 4px 20px rgba(0,0,0,0.3) !important;
    }}

    .calendar-section {{
        background: var(--card-bg) !important;
        color: var(--text-primary) !important;
        border: 2px solid var(--border-color) !important;
        border-radius: 16px !important;
        padding: 2rem !important;
        box-shadow: 0 4px 20px rgba(0,0,0,0.3) !important;
    }}

    .analytics-controls {{
        background: var(--card-bg) !important;
        color: var(--text-primary) !important;
        border-left: 5px solid var(--secondary-color) !important;
        border-radius: 16px !important;
        padding: 2rem !important;
        margin-bottom: 1rem !important;
        box-shadow: 0 4px 20px rgba(0,0,0,0.3) !important;
    }}

    .reminder-card {{
        background: var(--card-bg) !important;
        color: var(--text-primary) !important;
        border-left: 5px solid var(--secondary-color) !important;
        border-radius: 16px !important;
        padding: 2rem !important;
        margin: 1rem 0 !important;
        box-shadow: 0 4px 20px rgba(0,0,0,0.3) !important;
    }}

    .feedback-section {{
        background: var(--card-bg) !important;
        color: var(--text-primary) !important;
        border: 2px solid var(--border-color) !important;
        border-radius: 16px !important;
        padding: 2rem !important;
        box-shadow: 0 4px 20px rgba(0,0,0,0.3) !important;
    }}

    .gr-dataframe {{
        background: var(--card-bg) !important;
        color: var(--text-primary) !important;
        border: 2px solid var(--border-color) !important;
        border-radius: 12px !important;
        overflow: hidden !important;
    }}

    .gr-dataframe table {{
        background: var(--card-bg) !important;
        color: var(--text-primary) !important;
    }}

    .gr-dataframe th {{
        background: var(--primary-color) !important;
        color: white !important;
        font-weight: 600 !important;
        padding: 1rem !important;
    }}

    .gr-dataframe td {{
        background: var(--card-bg) !important;
        color: var(--text-primary) !important;
        padding: 0.8rem 1rem !important;
        border-bottom: 1px solid var(--border-color) !important;
    }}

    .gr-box, .gr-form, .gr-panel {{
        background: var(--card-bg) !important;
        color: var(--text-primary) !important;
        border-color: var(--border-color) !important;
    }}

    label, .gr-label {{
        color: var(--text-primary) !important;
        font-weight: 600 !important;
        font-size: 1.1rem !important;
        margin-bottom: 0.5rem !important;
    }}

    .gr-markdown {{
        color: var(--text-primary) !important;
    }}

    .gr-markdown h1, .gr-markdown h2, .gr-markdown h3, .gr-markdown h4 {{
        color: var(--text-primary) !important;
        margin-bottom: 1rem !important;
    }}

    table, th, td {{
        border-color: var(--border-color) !important;
        color: var(--text-primary) !important;
    }}

    ::-webkit-scrollbar {{
        width: 8px;
    }}

    ::-webkit-scrollbar-track {{
        background: var(--card-bg);
    }}

    ::-webkit-scrollbar-thumb {{
        background: var(--secondary-color);
        border-radius: 4px;
    }}

    ::-webkit-scrollbar-thumb:hover {{
        background: var(--accent-color);
    }}

    * {{
        transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
    }}

    .gr-radio, .gr-checkbox {{
        color: var(--text-primary) !important;
    }}

    .gr-radio-item, .gr-checkbox-item {{
        background: var(--card-bg) !important;
        color: var(--text-primary) !important;
        border: 2px solid var(--border-color) !important;
    }}

    .gr-dropdown {{
        background: var(--card-bg) !important;
        color: var(--text-primary) !important;
        border: 2px solid var(--border-color) !important;
    }}

    .gr-dropdown-options {{
        background: var(--card-bg) !important;
        color: var(--text-primary) !important;
        border: 2px solid var(--border-color) !important;
    }}
    </style>
    """

def apply_theme(theme_name):
    """Apply the selected theme"""
    return get_theme_css(theme_name)

# === Multilingual Support ===
LANGUAGE_TRANSLATIONS = {
    'English': {
        'welcome': 'Welcome to AI Memory Plan',
        'login': 'Login',
        'register': 'Register',
        'add_memory': 'Add Memory',
        'view_memories': 'View Memories',
        'analytics': 'Analytics',
        'calendar': 'Calendar',
        'profile': 'Profile',
        'reminders': 'Smart Reminders',
        'save': 'Save',
        'cancel': 'Cancel',
        'feedback': 'Give Feedback',
        'feedback_submitted': 'Feedback Submitted',
        'rate_experience': 'Rate your experience',
        'comments': 'Comments (optional)'
    },
    'Spanish': {
        'welcome': 'Bienvenido a AI Memory Plan',
        'login': 'Iniciar Sesi√≥n',
        'register': 'Registrarse',
        'add_memory': 'Agregar Memoria',
        'view_memories': 'Ver Memorias',
        'analytics': 'Anal√≠ticas',
        'calendar': 'Calendario',
        'profile': 'Perfil',
        'reminders': 'Recordatorios Inteligentes',
        'save': 'Guardar',
        'cancel': 'Cancelar',
        'feedback': 'Dar Comentarios',
        'feedback_submitted': 'Comentarios Enviados',
        'rate_experience': 'Califica tu experiencia',
        'comments': 'Comentarios (opcional)'
    },
    'French': {
        'welcome': 'Bienvenue √† AI Memory Plan',
        'login': 'Connexion',
        'register': 'S\'inscrire',
        'add_memory': 'Ajouter un Souvenir',
        'view_memories': 'Voir les Souvenirs',
        'analytics': 'Analytiques',
        'calendar': 'Calendrier',
        'profile': 'Profil',
        'reminders': 'Rappels Intelligents',
        'save': 'Sauvegarder',
        'cancel': 'Annuler',
        'feedback': 'Donner un Avis',
        'feedback_submitted': 'Avis Soumis',
        'rate_experience': '√âvaluez votre exp√©rience',
        'comments': 'Commentaires (optionnel)'
    },
    'Hindi': {
        'welcome': '‡§è‡§Ü‡§à ‡§Æ‡•á‡§Æ‡•ã‡§∞‡•Ä ‡§™‡•ç‡§≤‡§æ‡§® ‡§Æ‡•á‡§Ç ‡§Ü‡§™‡§ï‡§æ ‡§∏‡•ç‡§µ‡§æ‡§ó‡§§ ‡§π‡•à',
        'login': '‡§≤‡•â‡§ó‡§ø‡§®',
        'register': '‡§™‡§Ç‡§ú‡•Ä‡§ï‡§∞‡§£',
        'add_memory': '‡§Ø‡§æ‡§¶ ‡§ú‡•ã‡§°‡§º‡•á‡§Ç',
        'view_memories': '‡§Ø‡§æ‡§¶‡•á‡§Ç ‡§¶‡•á‡§ñ‡•á‡§Ç',
        'analytics': '‡§µ‡§ø‡§∂‡•ç‡§≤‡•á‡§∑‡§£',
        'calendar': '‡§ï‡•à‡§≤‡•á‡§Ç‡§°‡§∞',
        'profile': '‡§™‡•ç‡§∞‡•ã‡§´‡§æ‡§á‡§≤',
        'reminders': '‡§∏‡•ç‡§Æ‡§æ‡§∞‡•ç‡§ü ‡§Ö‡§®‡•Å‡§∏‡•ç‡§Æ‡§æ‡§∞‡§ï',
        'save': '‡§∏‡•á‡§µ ‡§ï‡§∞‡•á‡§Ç',
        'cancel': '‡§∞‡§¶‡•ç‡§¶ ‡§ï‡§∞‡•á‡§Ç',
        'feedback': '‡§™‡•ç‡§∞‡§§‡§ø‡§ï‡•ç‡§∞‡§ø‡§Ø‡§æ ‡§¶‡•á‡§Ç',
        'feedback_submitted': '‡§™‡•ç‡§∞‡§§‡§ø‡§ï‡•ç‡§∞‡§ø‡§Ø‡§æ ‡§∏‡§¨‡§Æ‡§ø‡§ü ‡§π‡•ã ‡§ó‡§à',
        'rate_experience': '‡§Ö‡§™‡§®‡•á ‡§Ö‡§®‡•Å‡§≠‡§µ ‡§ï‡•ã ‡§∞‡•á‡§ü ‡§ï‡§∞‡•á‡§Ç',
        'comments': '‡§ü‡§ø‡§™‡•ç‡§™‡§£‡§ø‡§Ø‡§æ‡§Å (‡§µ‡•à‡§ï‡§≤‡•ç‡§™‡§ø‡§ï)'
    },
    'Marathi': {
        'welcome': 'AI ‡§Æ‡•á‡§Æ‡§∞‡•Ä ‡§™‡•ç‡§≤‡•Ö‡§® ‡§Æ‡§ß‡•ç‡§Ø‡•á ‡§Ü‡§™‡§≤‡•á ‡§∏‡•ç‡§µ‡§æ‡§ó‡§§ ‡§Ü‡§π‡•á',
        'login': '‡§≤‡•â‡§ó‡§ø‡§®',
        'register': '‡§®‡•ã‡§Ç‡§¶‡§£‡•Ä',
        'add_memory': '‡§∏‡•ç‡§Æ‡§∞‡§£ ‡§ú‡•ã‡§°‡§æ',
        'view_memories': '‡§∏‡•ç‡§Æ‡§∞‡§£ ‡§™‡§π‡§æ',
        'analytics': '‡§µ‡§ø‡§∂‡•ç‡§≤‡•á‡§∑‡§£',
        'calendar': '‡§ï‡•Ö‡§≤‡•á‡§Ç‡§°‡§∞',
        'profile': '‡§™‡•ç‡§∞‡•ã‡§´‡§æ‡§á‡§≤',
        'reminders': '‡§∏‡•ç‡§Æ‡§æ‡§∞‡•ç‡§ü ‡§∞‡§ø‡§Æ‡§æ‡§á‡§Ç‡§°‡§∞',
        'save': '‡§ú‡§§‡§® ‡§ï‡§∞‡§æ',
        'cancel': '‡§∞‡§¶‡•ç‡§¶ ‡§ï‡§∞‡§æ',
        'feedback': '‡§Ö‡§≠‡§ø‡§™‡•ç‡§∞‡§æ‡§Ø ‡§¶‡•ç‡§Ø‡§æ',
        'feedback_submitted': '‡§Ö‡§≠‡§ø‡§™‡•ç‡§∞‡§æ‡§Ø ‡§∏‡§¨‡§Æ‡§ø‡§ü ‡§ï‡•á‡§≤‡§æ',
        'rate_experience': '‡§§‡•Å‡§Æ‡§ö‡§æ ‡§Ö‡§®‡•Å‡§≠‡§µ ‡§∞‡•á‡§ü ‡§ï‡§∞‡§æ',
        'comments': '‡§ü‡§ø‡§™‡•ç‡§™‡§£‡•ç‡§Ø‡§æ (‡§™‡§∞‡•ç‡§Ø‡§æ‡§Ø‡•Ä)'
    }
}

def get_translation(language, key):
    """Get translation for given language and key"""
    return LANGUAGE_TRANSLATIONS.get(language, LANGUAGE_TRANSLATIONS['English']).get(key, key)

# === Create the Complete Interface ===
def create_interface():
    """Create the complete Gradio interface"""

    with gr.Blocks(theme=gr.themes.Default(), title="AI Memory Plan") as demo:

        theme_css = gr.HTML(value=apply_theme(current_user.get('theme', 'default')))

        # Header
        with gr.Row(elem_classes="grok-header"):
            with gr.Column():
                gr.Markdown("# üß† AI MEMORY PLAN", elem_classes="grok-logo")
                gr.Markdown("Intelligent Memory Assistant for Alzheimer Patients", elem_classes="grok-subtitle")

        # Main Container
        with gr.Column(elem_id="main-container"):

            # Login/Registration Screen
            login_screen = gr.Column(visible=True, elem_id="login-screen")
            with login_screen:

                # Hero Section
                with gr.Row():
                    with gr.Column():
                        with gr.Column(elem_classes="hero-image"):
                            gr.Markdown("""
                            <div style="text-align: center;">
                                <h3 style="margin-bottom: 0.5rem;">üß† AI-Powered Memory Tracking</h3>
                                <p style="margin: 0;">Preserve precious memories with emotion analysis and OCR technology</p>
                            </div>
                            """)

                # Features Grid
                with gr.Row():
                    with gr.Column():
                        gr.Markdown("### ‚ú® Key Features")
                        with gr.Row():
                            with gr.Column(elem_classes="feature-card"):
                                gr.Markdown("""
                                <div style="font-size: 2rem; margin-bottom: 1rem;">üìù</div>
                                <h4>Smart Memory Entry</h4>
                                <p>Record memories with AI-powered emotion detection</p>
                                """)
                            with gr.Column(elem_classes="feature-card"):
                                gr.Markdown("""
                                <div style="font-size: 2rem; margin-bottom: 1rem;">üì∑</div>
                                <h4>Image Analysis</h4>
                                <p>Extract text from photos using OCR technology</p>
                                """)
                        with gr.Row():
                            with gr.Column(elem_classes="feature-card"):
                                gr.Markdown("""
                                <div style="font-size: 2rem; margin-bottom: 1rem;">üìä</div>
                                <h4>Emotion Analytics</h4>
                                <p>Track emotional trends with beautiful visualizations</p>
                                """)
                            with gr.Column(elem_classes="feature-card"):
                                gr.Markdown("""
                                <div style="font-size: 2rem; margin-bottom: 1rem;">üîî</div>
                                <h4>Smart Reminders</h4>
                                <p>Get WhatsApp reminders for important events</p>
                                """)

                # Login/Registration Tabs
                with gr.Tabs() as auth_tabs:
                    with gr.TabItem("üîê Login"):
                        with gr.Row():
                            with gr.Column(scale=1):
                                gr.Markdown("## Welcome Back")
                                gr.Markdown("Sign in to access your memory dashboard and analytics.")
                            with gr.Column(scale=1):
                                log_user = gr.Textbox(label="Username", placeholder="Enter your username",
                                                    elem_classes="grok-input")
                                log_pass = gr.Textbox(label="Password", type="password",
                                                    placeholder="Enter your password", elem_classes="grok-input")
                                log_btn = gr.Button("Login to Dashboard", elem_classes="grok-button")
                                log_out = gr.Textbox(label="Status", show_label=False)

                    with gr.TabItem("üöÄ Register"):
                        with gr.Row():
                            with gr.Column(scale=1):
                                gr.Markdown("## Start Your Journey")
                                gr.Markdown("Create an account to begin tracking memories with AI analysis.")
                            with gr.Column(scale=1):
                                reg_user = gr.Textbox(label="Username", placeholder="Choose username",
                                                    elem_classes="grok-input")
                                reg_pass = gr.Textbox(label="Password", type="password",
                                                    placeholder="Create password", elem_classes="grok-input")
                                reg_name = gr.Textbox(label="Full Name", placeholder="Your full name",
                                                    elem_classes="grok-input")
                                reg_phone = gr.Textbox(label="Phone Number (for WhatsApp reminders - Optional)",
                                                     placeholder="+1234567890", elem_classes="grok-input")
                                reg_language = gr.Dropdown(choices=['English', 'Spanish', 'French', 'Hindi', 'Marathi'],
                                                         label="Preferred Language", value='English',
                                                         elem_classes="grok-input")
                                reg_theme = gr.Dropdown(choices=['default', 'happy', 'calm', 'energetic'],
                                                      label="Theme Preference", value='default',
                                                      elem_classes="grok-input")
                                reg_btn = gr.Button("Create Memory Account", elem_classes="grok-button")
                                reg_out = gr.Textbox(label="Status", show_label=False)
                                password_feedback = gr.HTML(label="Password Strength")

                        # Password validation
                        def update_password_strength(password):
                            if not password:
                                return ""
                            is_valid, message = validate_password(password)
                            color = "green" if is_valid else "orange" if len(password) >= 6 else "red"
                            return f"<div style='color: {color}; font-weight: bold;'>{message}</div>"

                        reg_pass.change(
                            update_password_strength,
                            inputs=[reg_pass],
                            outputs=[password_feedback]
                        )

            # Main Application Screen
            app_screen = gr.Column(visible=False, elem_id="app-screen")
            with app_screen:

                # User Status Display
                with gr.Row():
                    with gr.Column():
                        user_status = gr.HTML(label="User Status")

                # Main Tabs
                with gr.Tabs(elem_classes="grok-container") as tabs:

                    # Add Memory Tab
                    with gr.TabItem("üìù Add Memory", elem_classes="grok-tab") as add_memory_tab:
                        with gr.Row():
                            with gr.Column(scale=1):
                                gr.Markdown("## Capture Your Moment")
                                gr.Markdown("Record memories with text, photos, and emotional analysis.")

                                text_input = gr.Textbox(label="Memory Description *",
                                                      placeholder="Today I felt... I visited... I remembered...",
                                                      lines=4, elem_classes="grok-input")

                                with gr.Row():
                                    day_select = gr.Dropdown(
                                        choices=["Monday","Tuesday","Wednesday","Thursday","Friday","Saturday","Sunday"],
                                        label="Select Day *",
                                        value=datetime.datetime.now().strftime("%A"),
                                        elem_classes="grok-input"
                                    )

                                image_input = gr.Image(label="Upload Memory Photo (Optional)", type="numpy",
                                                     elem_classes="grok-input")

                                submit_btn = gr.Button("Analyze & Save Memory", elem_classes="grok-button")

                            with gr.Column(scale=1):
                                output = gr.JSON(label="Memory Analysis", elem_classes="grok-card")

                    # Memory Library Tab
                    with gr.TabItem("üìö Memory Library", elem_classes="grok-tab") as memory_library_tab:
                        with gr.Row():
                            with gr.Column(scale=2):
                                gr.Markdown("## Your Memory Timeline")
                                gr.Markdown("Browse through your recorded memories and view associated images.")
                                with gr.Row():
                                    view_btn = gr.Button("Load Recent Memories", elem_classes="grok-button")
                                    export_btn = gr.Button("Export All Data", elem_classes="grok-button")

                                with gr.Row():
                                    memory_select = gr.Dropdown(
                                        label="Select Memory to View Details",
                                        choices=[],
                                        elem_classes="grok-input",
                                        interactive=True
                                    )
                                    view_details_btn = gr.Button("View Memory Details", elem_classes="grok-button")

                                table = gr.Dataframe(label="Memory History", wrap=True, elem_classes="grok-card")
                                export_output = gr.Textbox(label="Export Status", show_label=False)

                            with gr.Column(scale=1):
                                gr.Markdown("## Memory Details & Image")
                                memory_details = gr.HTML(label="Memory Details", value="<div class='memory-details'><p>Select a memory to view details and image</p></div>")
                                memory_image = gr.Image(label="Memory Image", elem_classes="grok-card", height=400)

                        memories_state = gr.State(value=[])

                    # Enhanced Analytics Tab
                    with gr.TabItem("üìä Analytics", elem_classes="grok-tab") as analytics_tab:
                        with gr.Row():
                            with gr.Column(scale=1):
                                gr.Markdown("## Advanced Emotional Analytics")
                                gr.Markdown("Understand your emotional journey through comprehensive AI analysis.")

                                with gr.Row():
                                    with gr.Column():
                                        analysis_type = gr.Dropdown(
                                            choices=["bar", "pie", "line"],
                                            label="Chart Type",
                                            value="bar",
                                            elem_classes="grok-input"
                                        )
                                    with gr.Column():
                                        time_range = gr.Dropdown(
                                            choices=["all", "daily", "weekly", "monthly"],
                                            label="Time Range",
                                            value="all",
                                            elem_classes="grok-input"
                                        )

                                trend_btn = gr.Button("Generate Trends", elem_classes="grok-button")

                            with gr.Column(scale=2):
                                trend_img = gr.Image(label="Emotional Journey", elem_classes="grok-card")

                    # Calendar Tab
                    with gr.TabItem("üìÖ Calendar View", elem_classes="grok-tab") as calendar_tab:
                        with gr.Row():
                            with gr.Column(scale=1):
                                gr.Markdown("## Your Memory Calendar")
                                gr.Markdown("Visualize your memories across time. Days with memories are marked with *.")

                                with gr.Row():
                                    prev_month_btn = gr.Button("‚Üê Previous Month", elem_classes="grok-button-secondary")
                                    current_month_display = gr.HTML(
                                        value=f"<div style='text-align: center;'><h3 class='calendar-title'>{datetime.datetime.now().strftime('%B %Y')}</h3></div>"
                                    )
                                    next_month_btn = gr.Button("Next Month ‚Üí", elem_classes="grok-button-secondary")

                                calendar_display = gr.HTML(
                                    label="Interactive Calendar"
                                )

                                gr.Markdown("### Quick Date Search")
                                gr.Markdown("Enter a date manually to view memories from that day.")

                                with gr.Row():
                                    calendar_date = gr.Textbox(
                                        label="Enter Date (YYYY-MM-DD)",
                                        placeholder="e.g., 2024-01-15",
                                        elem_classes="grok-input",
                                        scale=3
                                    )
                                    view_date_btn = gr.Button("View Date", elem_classes="grok-button", scale=1)
                                    today_btn = gr.Button("Today", elem_classes="grok-button-secondary", scale=1)

                            with gr.Column(scale=1):
                                gr.Markdown("## Memories for Selected Date")
                                gr.Markdown("Memories will appear here when you select a date")

                                calendar_memories = gr.HTML(
                                    label="Date Memories"
                                )

                                calendar_memory_image = gr.Image(
                                    label="Memory Image from Selected Date",
                                    elem_classes="grok-card",
                                    height=300,
                                    visible=False
                                )

                        current_year_state = gr.State(value=datetime.datetime.now().year)
                        current_month_state = gr.State(value=datetime.datetime.now().month)

                    # Smart Reminders Tab
                    with gr.TabItem("üîî Smart Reminders", elem_classes="grok-tab") as reminders_tab:
                        with gr.Row():
                            with gr.Column(scale=1):
                                gr.Markdown("## Set Smart Reminders")
                                gr.Markdown("Create reminders for important events, mood check-ins, or self-care activities.")

                                reminder_title = gr.Textbox(label="Reminder Title *",
                                                          placeholder="e.g., Mood Check-in, Medication Time",
                                                          elem_classes="grok-input")

                                reminder_desc = gr.Textbox(label="Description",
                                                         placeholder="Optional details about the reminder",
                                                         lines=2, elem_classes="grok-input")

                                with gr.Row():
                                    reminder_date = gr.Textbox(label="Date (YYYY-MM-DD) *",
                                                             placeholder="2024-01-15",
                                                             elem_classes="grok-input")
                                    reminder_time = gr.Textbox(label="Time (HH:MM) *",
                                                             placeholder="14:30",
                                                             elem_classes="grok-input")

                                reminder_type = gr.Dropdown(choices=["Mood Check-in", "Medication", "Appointment",
                                                                   "Self-care", "Family Visit", "Other"],
                                                          label="Reminder Type", value="Mood Check-in",
                                                          elem_classes="grok-input")

                                create_reminder_btn = gr.Button("Create Reminder", elem_classes="grok-button")
                                reminder_output = gr.Textbox(label="Status", show_label=False)

                            with gr.Column(scale=1):
                                gr.Markdown("## Your Reminders")
                                gr.Markdown("Manage your existing reminders.")

                                with gr.Row():
                                    view_reminders_btn = gr.Button("Load Reminders", elem_classes="grok-button")
                                    delete_reminder_btn = gr.Button("Delete Selected", elem_classes="grok-button-secondary")

                                reminders_table = gr.Dataframe(label="Your Reminders", elem_classes="grok-card")
                                reminder_select = gr.Dropdown(label="Select Reminder to Delete",
                                                            choices=[], elem_classes="grok-input")

                                reminders_state = gr.State(value=[])

                    # Profile Tab with FIXED FEEDBACK
                    with gr.TabItem("üë§ Profile", elem_classes="grok-tab") as profile_tab:
                        with gr.Row():
                            with gr.Column(scale=1):
                                gr.Markdown("## Your Preferences")
                                gr.Markdown("Customize your experience with language and theme settings.")

                                profile_language = gr.Dropdown(choices=['English', 'Spanish', 'French', 'Hindi', 'Marathi'],
                                                             label="Language", value='English',
                                                             elem_classes="grok-input")

                                profile_theme = gr.Dropdown(choices=['default', 'happy', 'calm', 'energetic'],
                                                          label="Theme", value='default',
                                                          elem_classes="grok-input")

                                profile_phone = gr.Textbox(label="Phone Number (for WhatsApp reminders - Optional)",
                                                         placeholder="+1234567890",
                                                         elem_classes="grok-input")

                                update_prefs_btn = gr.Button("Update Preferences", elem_classes="grok-button")
                                prefs_output = gr.Textbox(label="Status", show_label=False)

                                # FIXED FEEDBACK SECTION
                                feedback_section = gr.Group(visible=True)
                                with feedback_section:
                                    gr.Markdown("## üí¨ Your Feedback")
                                    gr.Markdown("We value your opinion! Please share your experience with us.")

                                    # Use simple string choices for radio buttons
                                    feedback_rating = gr.Radio(
                                        choices=["1 - Poor", "2 - Fair", "3 - Good", "4 - Very Good", "5 - Excellent"],
                                        label="Rate your experience",
                                        elem_classes="grok-input"
                                    )
                                    feedback_comments = gr.Textbox(label="Comments (optional)",
                                                                 placeholder="Any suggestions or comments...",
                                                                 lines=3, elem_classes="grok-input")
                                    submit_feedback_btn = gr.Button("Submit Feedback", elem_classes="grok-button")
                                    feedback_output = gr.Textbox(label="Feedback Status", show_label=False)

                                # Thank you message (hidden initially)
                                feedback_thank_you = gr.Markdown(
                                    value="<div class='feedback-section' style='text-align: center; padding: 2rem;'><h3>üéâ Thank You for Your Feedback!</h3><p>We appreciate you taking the time to share your experience with us.</p></div>",
                                    visible=False
                                )

                            with gr.Column(scale=1):
                                gr.Markdown("## Your Memory Dashboard")
                                stats_display = gr.HTML(
                                    label="Memory Statistics"
                                )
                                with gr.Row():
                                    stats_btn = gr.Button("Refresh Statistics", elem_classes="grok-button")
                                    logout_btn = gr.Button("Logout", elem_classes="grok-button-secondary")

        # === Event Handlers ===

        def update_theme_on_preference_change(language, theme, phone_number):
            css = apply_theme(theme)
            result = update_preferences(language, theme, phone_number)
            return css, result

        def handle_successful_login():
            has_feedback = check_feedback_status()
            return (
                gr.update(visible=False),
                gr.update(visible=True),
                update_user_status(),
                apply_theme(current_user.get('theme', 'default')),
                gr.update(visible=not has_feedback),
                gr.update(visible=has_feedback)
            )

        def handle_logout():
            result = logout_user()
            return (
                gr.update(visible=True),
                gr.update(visible=False),
                result,
                "<div class='user-status user-status-logged-out'><h3>üîê Not Logged In</h3><p>Please log in to access all features</p></div>",
                apply_theme('default'),
                gr.update(visible=True),
                gr.update(visible=False)
            )

        def handle_register(username, password, name, phone, language, theme):
            result = register_user(username, password, name, phone, language, theme)
            if "‚úÖ" in result:
                login_result = login_user(username, password)
                if "‚úÖ" in login_result:
                    return handle_successful_login() + (login_result,)
            return (
                gr.update(),
                gr.update(),
                update_user_status(),
                apply_theme('default'),
                gr.update(visible=True),
                gr.update(visible=False),
                result
            )

        def handle_login(username, password):
            result = login_user(username, password)
            if "‚úÖ" in result:
                return handle_successful_login() + (result,)
            else:
                return (
                    gr.update(),
                    gr.update(),
                    update_user_status(),
                    apply_theme('default'),
                    gr.update(visible=True),
                    gr.update(visible=False),
                    result
                )

        # FIXED FEEDBACK HANDLER
        def handle_feedback_submission(rating, comments):
            """Fixed feedback submission handler"""
            if not rating:
                return "‚ùå Please select a rating first.", gr.update(visible=True), gr.update(visible=False)

            try:
                # Handle the rating string safely
                if isinstance(rating, str):
                    if ' - ' in rating:
                        rating_value = int(rating.split(' - ')[0])
                    else:
                        rating_value = int(rating)
                else:
                    rating_value = int(rating)

                result = submit_feedback(rating_value, comments)
                if "‚úÖ" in result:
                    # Hide feedback section, show thank you message
                    return result, gr.update(visible=False), gr.update(visible=True)
                else:
                    return result, gr.update(visible=True), gr.update(visible=False)

            except Exception as e:
                return f"‚ùå Error submitting feedback: {str(e)}", gr.update(visible=True), gr.update(visible=False)

        # Connect registration button
        reg_btn.click(
            handle_register,
            inputs=[reg_user, reg_pass, reg_name, reg_phone, reg_language, reg_theme],
            outputs=[login_screen, app_screen, user_status, theme_css, feedback_section, feedback_thank_you, reg_out]
        )

        # Connect login button
        log_btn.click(
            handle_login,
            inputs=[log_user, log_pass],
            outputs=[login_screen, app_screen, user_status, theme_css, feedback_section, feedback_thank_you, log_out]
        )

        # Connect logout button
        logout_btn.click(
            handle_logout,
            outputs=[login_screen, app_screen, log_out, user_status, theme_css, feedback_section, feedback_thank_you]
        )

        # Update preferences with theme change
        update_prefs_btn.click(
            update_theme_on_preference_change,
            inputs=[profile_language, profile_theme, profile_phone],
            outputs=[theme_css, prefs_output]
        )

        # Theme change handler
        profile_theme.change(
            lambda theme: apply_theme(theme),
            inputs=[profile_theme],
            outputs=[theme_css]
        )

        # FIXED Feedback submission
        submit_feedback_btn.click(
            handle_feedback_submission,
            inputs=[feedback_rating, feedback_comments],
            outputs=[feedback_output, feedback_section, feedback_thank_you]
        )

        # Reminders functionality
        def update_reminder_dropdown(reminders_list):
            if not reminders_list:
                return gr.Dropdown(choices=[])

            choices = []
            for reminder in reminders_list:
                label = f"{reminder['reminder_date']} {reminder['reminder_time']} - {reminder['title']}"
                choices.append((label, reminder["id"]))

            return gr.Dropdown(choices=choices)

        view_reminders_btn.click(
            view_reminders,
            outputs=[reminders_table, reminders_state]
        ).then(
            update_reminder_dropdown,
            inputs=[reminders_state],
            outputs=[reminder_select]
        )

        create_reminder_btn.click(
            create_reminder,
            inputs=[reminder_title, reminder_desc, reminder_date, reminder_time, reminder_type],
            outputs=[reminder_output]
        )

        delete_reminder_btn.click(
            delete_reminder,
            inputs=[reminder_select],
            outputs=[reminder_output]
        ).then(
            view_reminders,
            outputs=[reminders_table, reminders_state]
        ).then(
            update_reminder_dropdown,
            inputs=[reminders_state],
            outputs=[reminder_select]
        )

        # Memory functionality
        def update_memory_dropdown(memories_list):
            if not memories_list:
                return gr.Dropdown(choices=[])

            choices = []
            for memory in memories_list:
                label = f"{memory['date']} - {memory['text'][:50]}..."
                choices.append((label, memory["id"]))

            return gr.Dropdown(choices=choices, value=choices[0][1] if choices else None)

        view_btn.click(
            view_user_memories,
            outputs=[table, memories_state, memory_details, memory_image]
        ).then(
            update_memory_dropdown,
            inputs=[memories_state],
            outputs=[memory_select]
        )

        view_details_btn.click(
            view_memory_details,
            inputs=[memory_select, memories_state],
            outputs=[memory_details, memory_image]
        )

        memory_select.change(
            view_memory_details,
            inputs=[memory_select, memories_state],
            outputs=[memory_details, memory_image]
        )

        export_btn.click(export_user_data, outputs=[export_output])
        submit_btn.click(save_memory, inputs=[text_input, day_select, image_input], outputs=[output])

        # Enhanced Analytics functionality
        trend_btn.click(
            view_trends,
            inputs=[analysis_type, time_range],
            outputs=[trend_img]
        )

        stats_btn.click(get_user_stats, outputs=[stats_display])

        # Calendar navigation functions
        def navigate_prev_month(current_year, current_month):
            prev_year, prev_month = (current_year-1, 12) if current_month == 1 else (current_year, current_month-1)
            calendar_html = generate_calendar_view(prev_year, prev_month)
            month_name = calendar.month_name[prev_month]
            month_display = f"<div style='text-align: center;'><h3 class='calendar-title'>{month_name} {prev_year}</h3></div>"
            return calendar_html, prev_year, prev_month, month_display

        def navigate_next_month(current_year, current_month):
            next_year, next_month = (current_year+1, 1) if current_month == 12 else (current_year, current_month+1)
            calendar_html = generate_calendar_view(next_year, next_month)
            month_name = calendar.month_name[next_month]
            month_display = f"<div style='text-align: center;'><h3 class='calendar-title'>{month_name} {next_year}</h3></div>"
            return calendar_html, next_year, next_month, month_display

        def navigate_today():
            now = datetime.datetime.now()
            calendar_html = generate_calendar_view(now.year, now.month)
            month_name = calendar.month_name[now.month]
            month_display = f"<div style='text-align: center;'><h3 class='calendar-title'>{month_name} {now.year}</h3></div>"
            today_str = now.strftime("%Y-%m-%d")
            memories_html, image = view_calendar_memories(today_str)
            return calendar_html, now.year, now.month, month_display, today_str, memories_html, image if image else gr.update(visible=False)

        def handle_date_search(selected_date):
            if not selected_date:
                return "‚ùå Please enter a date first.", gr.update(), gr.update()

            is_valid, date_msg = validate_date(selected_date)
            if not is_valid:
                return f"‚ùå {date_msg}", gr.update(), gr.update()

            memories_html, image = view_calendar_memories(selected_date)
            return selected_date, memories_html, image if image else gr.update(visible=False)

        # Connect calendar navigation
        prev_month_btn.click(
            navigate_prev_month,
            inputs=[current_year_state, current_month_state],
            outputs=[calendar_display, current_year_state, current_month_state, current_month_display]
        )

        next_month_btn.click(
            navigate_next_month,
            inputs=[current_year_state, current_month_state],
            outputs=[calendar_display, current_year_state, current_month_state, current_month_display]
        )

        today_btn.click(
            navigate_today,
            outputs=[calendar_display, current_year_state, current_month_state, current_month_display, calendar_date, calendar_memories, calendar_memory_image]
        )

        view_date_btn.click(
            handle_date_search,
            inputs=[calendar_date],
            outputs=[calendar_date, calendar_memories, calendar_memory_image]
        )

        calendar_date.submit(
            handle_date_search,
            inputs=[calendar_date],
            outputs=[calendar_date, calendar_memories, calendar_memory_image]
        )

        # Update user status display
        def update_user_status():
            if current_user["username"]:
                return f"""
                <div class='user-status user-status-logged-in'>
                    <h3>üë§ Logged in as: {current_user['name']}</h3>
                    <p>Username: {current_user['username']} | Language: {current_user.get('language', 'English')} | Theme: {current_user.get('theme', 'default')}</p>
                    <p>üì± WhatsApp: {'‚úÖ Enabled' if current_user.get('phone_number') else '‚ùå Not configured'}</p>
                </div>
                """
            else:
                return """
                <div class='user-status user-status-logged-out'>
                    <h3>üîê Not Logged In</h3>
                    <p>Please log in to access all features</p>
                </div>
                """

        # Initialize app
        def initialize_app():
            return (
                gr.update(visible=True),
                gr.update(visible=False),
                update_user_status(),
                apply_theme('default'),
                gr.update(visible=True),
                gr.update(visible=False)
            )

        demo.load(
            initialize_app,
            outputs=[login_screen, app_screen, user_status, theme_css, feedback_section, feedback_thank_you]
        )

    return demo

# Create and launch the interface
print("üöÄ Starting Enhanced AI Memory Plan Application...")
print("üìÅ Database Location:", DB_FILE)
print("‚úÖ Google Drive Mounted:", DRIVE_MOUNTED)
print("üîî WhatsApp Reminders: Configured with Twilio")
print("üé® Theme System: Active with beautiful color palettes")
print("üó£Ô∏è Languages: English, Spanish, French, Hindi, Marathi")
print("üí¨ Feedback System: Fixed and working properly")
print("üìä Enhanced Analytics: Bar, Pie, Line charts with time ranges")
print("üß† Emotion Analysis: Advanced model + Hugging Face dataset integration")
print("üìÅ External Dataset: Ready for upload")
print("üîÑ Database migration completed!")

demo = create_interface()
demo.launch(share=True, debug=True)